// Automatically generated by PRGA's RTL generator
`include "pktchain.vh"
module pktchain_assemble #(
    parameter DEPTH_LOG2 = 1,   // depth in terms of frames
    parameter DATA_WIDTH_LOG2 = `FRAME_SIZE_LOG2
) (
    input wire [0:0] cfg_clk,
    input wire [0:0] cfg_rst,

    // noc inputs (FIFO intf)
    output reg [0:0] phit_full,
    input wire [0:0] phit_wr,
    input wire [`PHIT_WIDTH - 1:0] phit_i,

    // frame buffer output (FIFO intf)
    output reg [0:0] frame_empty,
    input wire [0:0] frame_rd,
    output wire [(1 << DATA_WIDTH_LOG2) - 1:0] frame_o
    );

    localparam  PHIT_COUNTER_LOG2 = DATA_WIDTH_LOG2 - `PHIT_WIDTH_LOG2;
    localparam  FIFO_COUNTER_LOG2 = DEPTH_LOG2 + PHIT_COUNTER_LOG2;
    localparam  FIFO_DEPTH = 1 << FIFO_COUNTER_LOG2;

    reg [`PHIT_WIDTH - 1:0] data [FIFO_DEPTH - 1:0];
    reg [FIFO_COUNTER_LOG2:0] wr_ptr, rd_ptr;

    always @(posedge cfg_clk or posedge cfg_rst) begin
        if (cfg_rst) begin
            wr_ptr <= 'b0;
            rd_ptr <= 'b0;
        end else begin
            if (~phit_full && phit_wr) begin
                data[wr_ptr[0 +: FIFO_COUNTER_LOG2]] <= phit_i;
                wr_ptr <= wr_ptr + 1;
            end

            if (~frame_empty && frame_rd) begin
                rd_ptr <= rd_ptr + (1 << PHIT_COUNTER_LOG2);
            end
        end
    end

    always @* begin
        phit_full = cfg_rst || rd_ptr == {~wr_ptr[FIFO_COUNTER_LOG2], wr_ptr[0 +: FIFO_COUNTER_LOG2]};
        frame_empty = cfg_rst || rd_ptr == wr_ptr;
    end

    genvar i;
    generate for (i = 0; i < (1 << PHIT_COUNTER_LOG2); i = i + 1) begin: frame_assemble
        assign frame_o[((1 << PHIT_COUNTER_LOG2) - i - 1) * `PHIT_WIDTH +: `PHIT_WIDTH] = data[rd_ptr + i];
    end endgenerate

endmodule
